name: Create Release

on:
  workflow_dispatch:
    inputs:
      workflow_id:
        description: 'Build workflow run ID to use for artifacts'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts from workflow
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow_conclusion: success
          run_id: ${{ github.event.inputs.workflow_id }}
          path: artifacts

      - name: List downloaded artifacts
        run: find artifacts -type f | sort

      - name: Get version number
        id: get_version
        run: |
          VERSION_FILE=$(find artifacts/deepchat-linux-x64 -name "DeepChat-*.tar.gz" | head -n 1)
          if [ -n "$VERSION_FILE" ]; then
            VERSION=$(echo $VERSION_FILE | grep -o 'DeepChat-[0-9]\+\.[0-9]\+\.[0-9]\+' | sed 's/DeepChat-//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Found version: $VERSION"
          else
            echo "Error: DeepChat tar.gz file not found"
            exit 1
          fi

      - name: Prepare release assets
        run: |
          mkdir -p release_assets

          # Process Windows x64 artifacts
          if [ -d "artifacts/deepchat-win-x64" ]; then
            cp artifacts/deepchat-win-x64/*.exe release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-win-x64/*.msi release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-win-x64/*.zip release_assets/ 2>/dev/null || true
          fi

          # Process Windows arm64 artifacts
          #if [ -d "artifacts/deepchat-win-arm64" ]; then
          #  cp artifacts/deepchat-win-arm64/*.exe release_assets/ 2>/dev/null || true
          #  cp artifacts/deepchat-win-arm64/*.msi release_assets/ 2>/dev/null || true
          #  cp artifacts/deepchat-win-arm64/*.zip release_assets/ 2>/dev/null || true
          #fi

          # Process Linux x64 artifacts
          if [ -d "artifacts/deepchat-linux-x64" ]; then
            cp artifacts/deepchat-linux-x64/*.AppImage release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.deb release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.rpm release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.tar.gz release_assets/ 2>/dev/null || true
          fi

          # Process Mac x64 artifacts
          if [ -d "artifacts/deepchat-mac-x64" ]; then
            cp artifacts/deepchat-mac-x64/*.dmg release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-mac-x64/*.zip release_assets/ 2>/dev/null || true
          fi

          # Process Mac arm64 artifacts
          if [ -d "artifacts/deepchat-mac-arm64" ]; then
            cp artifacts/deepchat-mac-arm64/*.dmg release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-mac-arm64/*.zip release_assets/ 2>/dev/null || true
          fi

          ls -la release_assets/

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: DeepChat V${{ steps.get_version.outputs.version }}
          draft: true
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            release_assets/*
          body: |
            # ğŸš€ DeepChat ${{ steps.get_version.outputs.version }} æ­£å¼å‘å¸ƒ | é‡æ–°å®šä¹‰ä½ çš„ AI å¯¹è¯ä½“éªŒï¼
            â€”â€” ä¸å†æ˜¯ç®€å•çš„ ChatBotï¼Œè€Œæ˜¯ä½ çš„è‡ªç„¶è¯­è¨€ Agent  å·¥å…·ğŸŒŸ

            ğŸ”¥ ä¸ºä»€ä¹ˆé€‰æ‹© DeepChatï¼Ÿ

            âœ… **å•†ä¸šå‹å¥½**ï¼šåŸºäºåŸç‰ˆ [Apache License 2.0](https://github.com/ThinkInAIXYZ/deepchat/blob/main/LICENSE) å¼€æºï¼Œæ— ä»»ä½•åè®®å¤–çš„é¢å¤–çº¦æŸï¼Œé¢å‘å¼€æºã€‚
            âœ… **å¼€ç®±å³ç”¨**ï¼šæç®€é…ç½®ï¼Œå³åˆ»å¼€å¯ä½ çš„æ™ºèƒ½å¯¹è¯ä¹‹æ—…ã€‚
            âœ… **æè‡´çµæ´»**ï¼šè‡ªç”±åˆ‡æ¢æ¨¡å‹ï¼Œè‡ªå®šä¹‰æ¨¡å‹æºï¼Œæ»¡è¶³ä½ å¤šæ ·åŒ–çš„å¯¹è¯å’Œæ¢ç´¢éœ€æ±‚ã€‚
            âœ… **ä½“éªŒç»ä½³**ï¼šLaTeX å…¬å¼æ¸²æŸ“ã€ä»£ç é«˜äº®ã€Markdown æ”¯æŒï¼Œæ¨¡å‹å¯¹è¯ä»æœªå¦‚æ­¤é¡ºç•…ã€‚
            âœ… **æŒç»­è¿›åŒ–**ï¼šæˆ‘ä»¬å€¾å¬ç”¨æˆ·åé¦ˆï¼Œä¸æ–­è¿­ä»£æ›´æ–°ï¼Œä¸ºä½ å¸¦æ¥æ›´å“è¶Šçš„ AI å¯¹è¯ä½“éªŒã€‚

            ğŸ“¥ ç«‹å³ä½“éªŒæœªæ¥

            ğŸ’¬ åé¦ˆæœ‰ç¤¼ï¼šæ¬¢è¿æäº¤ä½ çš„å®è´µå»ºè®®ï¼ŒåŠ å…¥ VIP ç”¨æˆ·ç¤¾ç¾¤ï¼Œä¸æˆ‘ä»¬ä¸€åŒå¡‘é€  DeepChat çš„æœªæ¥ï¼
            <img width="400px" src="https://github.com/user-attachments/assets/2ebc21e8-3eef-4a11-b3ab-de28e8f9d9c0"/>

            ğŸ® åŠ å…¥ Discord ç¤¾åŒºï¼š[https://discord.gg/6RBatENX](https://discord.gg/6RBatENX)

            ---

            # ğŸš€ DeepChat ${{ steps.get_version.outputs.version }} Official Release | Redefine Your AI Conversation Experience!
            â€”â€” Not just a simple ChatBot, but your natural language Agent tool ğŸŒŸ

            ğŸ”¥ Why Choose DeepChat?

            âœ… **Business-Friendly**: Open source under [Apache License 2.0](https://github.com/ThinkInAIXYZ/deepchat/blob/main/LICENSE), with no additional constraints beyond the license, truly open source.
            âœ… **Ready to Use**: Minimal configuration, start your intelligent conversation journey immediately.
            âœ… **Ultra Flexible**: Freely switch models, customize model sources, meet your diverse conversation and exploration needs.
            âœ… **Excellent Experience**: LaTeX formula rendering, code highlighting, Markdown support, model conversations have never been smoother.
            âœ… **Continuous Evolution**: We listen to user feedback, continuously iterate and update, bringing you an even better AI conversation experience.

            ğŸ“¥ Experience the Future Now

            ğŸ’¬ Feedback Welcome: We welcome your valuable suggestions, join the user community, and shape the future of DeepChat together!

            <img width="400px" src="https://github.com/user-attachments/assets/2ebc21e8-3eef-4a11-b3ab-de28e8f9d9c0"/>

            ğŸ® Join Discord Community: [https://discord.gg/6RBatENX](https://discord.gg/6RBatENX)

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
